<html>
	<head>
		<meta name="apple-mobile-web-app-capable" content="yes">
		<title>Canvas Over Video
		</title>
	</head>

	<script type="text/javascript">

		/* Objets */
		var can, vid, playButton, time, acc, posX, posY, touch, tmp;

		/* Timer */ 
		var vidTimer;

		/* Recupere tous les elements*/
		function init() {
			/* Canvas, context and document */
			can = document.getElementById("can");
			ctx = can.getContext("2d");
			can.addEventListener("touchstart", touchDown, false);
			can.addEventListener("touchmove", touchXY, true);
			can.addEventListener("touchend", touchUp, false);
			document.body.addEventListener("touchcancel", touchUp, false);


			/* Objects : button and video */
			vid = document.getElementById("vid");
			vid.addEventListener('ended', vidEnd, false);
			playButton = document.getElementById("play");

			/* Affichages */
			time = document.getElementById("curtime");
			debug = document.getElementById("debug");
			pos = document.getElementById("position");
			tmp = document.getElementById("temps");	
			/* Empecher le scroll et le zoom */
			document.body.addEventListener('touchmove', function(event) {
									event.preventDefault();
								}, false); 
		}

		function curtime(){
			time.innerText = Math.round(vid.currentTime);
			if(vid.currentTime > 1 && vid.currentTime <= 2){ /* Oblige car au tout debut on a pas la duree.Cest que au bout de une seconde */
				tmp.innerText = Math.round(vid.duration); /* Returns the duration in seconds of the current media resource. A NaN value is returned if duration is not available, or Infinity if the media resource is streaming */
			}
		}

		/* Gestion du touch */
		/* Doigt leve */
		function touchUp() {
			mouseIsDown = 0;
		}

		/* Touch du doigt */
		function touchDown() {
			mouseIsDown = 1;
			touchXY();
		}

		/* Recupere levenement et le traite */
		function touchXY(e) {
			if (!e)
				var e = event;
			e.preventDefault();
			showPos(e.targetTouches[0].pageX - can.offsetLeft, e.targetTouches[0].pageY - can.offsetTop); 
		}

		/* Affiche la position et le cercle sous le doigt*/
		function showPos(canX, canY){
		  
			if(canX && canY && canX <= can.width && canY <= can.height && canX >= 0 && canY >= 0) {
				pos.innerText = "(" + canX + "," + canY + ")";
				time.innerText = Math.round(vid.currentTime);
			}
			ctx.clearRect(0, 0, document.width, document.height);

			ctx.beginPath();
			ctx.arc(canX, canY, 10, 0, 2 * Math.PI, false);
			ctx.fillStyle = 'white';
			ctx.fill();
		}

		/* Gestion de la video */
		/* Play */
		function playVideo() {
			if (playButton.value == "Play") {
				vid.play();
				playButton.value = "Pause";
				vidTimer = window.setInterval("curtime()",1000);
			}
			else {
				vid.pause();
				playButton.value = "Play";
			}
		}

		/* Forward*/
		function fwd(){
			vid.currentTime += 10;
		}

		/* Backward */
		function bwd(){
		  vid.currentTime -= 10;
		}

		/* Stop */
		function stop(){
			vid.currentTime = -1;
			vid.pause();
			if (playButton.value == "Pause") {
				playButton.value = "Play";		
			}
		}

		/* Plus lentement */
		function slower(){
			vid.playbackRate -= 0.25;
			vid.pause();
			vid.play();
		}

		/* Plus rapide */
		function faster(){
			vid.playbackRate += 0.25;
			vid.pause();
			vid.play();
		}
		
		/* Evenement de fin de video */
		function vidEnd() {
			playButton.value = "Play";
			vid.playbackRate = 1;
			clearTimeout(vidTimer)
		}	
	</script>


	<body onload="init()">
		<!-- Adapter taille a taille ecran -->
		<!--<video id="vid" width="512" height="288">-->
		<video id="vid" width = 871 height = 490>
			<source src="TBBT.mp4" type="video/mp4"  /> <!-- Safari / iOS, IE9 -->
			<!-- Ajouter un message si jamais la video n'est pas lisible par le broswer : "Lecture possible que pour Safari/Ios et IE9."-->
		</video>

		<canvas id="can" height= 490 width= 871 style="position:absolute; top: 10; left: 10;" style="background-color:black">
		</canvas>

		<p style="position:absolute; top:510; left: 30;"> 
			<!-- Voir comment faire pour gerer le multituch et integrer les commandes a des gestes plutot qu'avoir des boutons -->
			<input id="stop" type="button" value="[]" onclick="stop()" style="font:15pt Helvetica" />
			<input id="play" type="button" value="Play" onclick="playVideo()" style="font:15pt Helvetica" />
			<input id="arriere" type="button" value="<" onclick="bwd()" style="font:15pt Helvetica" />
			<input id="decc" type="button" value="dec" onclick="slower()" style="font:15pt Helvetica" />
			<input id="acc" type="button" value="acc" onclick="faster()" style="font:15pt Helvetica" />
			<input id="avant" type="button" value=">" onclick="fwd()" style="font:15pt Helvetica" />
			<br />

			<!-- Trouver comment avoir la duree totale (Vient de l'encodage du fichier ? Probable) -->
			Temps total : <span id ="temps"></span>
			<br/>
			<!-- Ajouter un timer pour avoir le temps qui defile --> 
			Temps courant : <span id ="curtime"></span>
			<br />
			<span id ="position"></span>
			<br/>
			<span id ="debug"></span>
			<br />
		</p>
	</body>
</html>

<!-- A venir, en vrac : 
Faire un timer pour avoir le defilement du texte
Faire tous les commentaires dans le code
Multitouch
Améliorer la mise en page -> Mettre video au format de l'écran
Avoir la video coupee en plan. Pour stoper au moment des changements de plan. Donner la possibilité de revenir au dernier debut de scene si plusieurs visages. 
Enregistrer les donnees sur le serveur.
Faire une traitement des donnees pour verifer si c'est bon. 
Gestion de la grosseur de l'objet/visage ?
->

